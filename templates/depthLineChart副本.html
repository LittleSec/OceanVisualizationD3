<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>twoYaxisScatter</title>
    <script src="../static/lib/js/jquery-3.3.1.js" type="text/javascript"></script>
    <script src="../static/lib/js/d3.v3.js" type="text/javascript"></script>
    <script src="../static/lib/js/crossfilter.js" type="text/javascript"></script>
    <script src="../static/lib/js/dc.js" type="text/javascript"></script>
    <link rel="stylesheet" href="../static/lib/css/dc.css" />
    <style>
    </style>
</head>

<body>
    <div id="depth-line-chart">
    </div>

    <script>
        var moveChart = dc.compositeChart("#depth-line-chart");

        d3.json("./lonlat.json", function (error, data) {
            var dateFormat = d3.time.format("%Y-%m-%d");
            var numberFormat = d3.format(".2f");

            data.forEach(function (d) {
                d.de = parseFloat(d.depth);
            });
            var ndx = crossfilter(data);

            var depthDimension = ndx.dimension(function (d) {
                return d.de;
            })

            var dateDimension = ndx.dimension(function (d) {
                return d.date;
            });
            dateDimension.filter("2017-09-14");
            // date = dateFormat.parse(curdate);
            var y1group = depthDimension.group().reduceSum(function (d) {
                return +d['surf_el'];
            });
            var y2group = depthDimension.group().reduceSum(function (d) {
                return +d['water_temp'];
            });

            // console.log(y1group.top(Infinity));
            // moveChart.width(600)
            //      .height(300)
            //      .x(d3.scale.ordinal().domain([]))
            //      .xUnits(dc.units.ordinal)
            //      .brushOn(false)
            //      .xAxisLabel("fu")
            //      .yAxisLabel('he')
            //      .dimension(depthDimension)
            //      .group(y1group);
            // moveChart.render();
            function nonzero_min(chart) {
                dc.override(chart, 'yAxisMin', function () {
                    var min = d3.min(chart.data(), function (layer) {
                        return d3.min(layer.values, function (p) {
                            return p.y + p.y0;
                        });
                    });
                    return dc.utils.subtract(min, chart.yAxisPadding());
                });
                return chart;
            }
            moveChart.width(600)
                .height(300)
                .transitionDuration(100)
                .margins({ top: 30, right: 50, bottom: 25, left: 60 })
                .dimension(depthDimension)
                .x(d3.scale.linear().domain([-10, 60]))
                .legend(dc.legend().x(70).y(10).itemHeight(13).gap(5))
                .brushOn(false)
                .elasticY(true)
                .compose([
                    nonzero_min(dc.lineChart(moveChart)
                        .group(y1group, "Monthly Index Average")).elasticY(true),
                    nonzero_min(dc.lineChart(moveChart)
                        //.dimension(depthDimension)
                        .group(y2group, "Monthly Index Move").elasticY(true)
                        .ordinalColors(["orange"])
                        .useRightYAxis(true))
                ])
                .yAxisLabel("Monthly Index Average")
                .rightYAxisLabel("Monthly Index Move");
            moveChart.xAxis().tickValues([0, 8, 15, 30, 50]).tickFormat(function (d) {
                return d.toFixed(1) + 'm';
            });

            dc.renderAll();
        });
    </script>
</body>

</html>